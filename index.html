<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CRISP + Welcoming Cities LGA Map</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Patterns -->
  <script src="https://unpkg.com/leaflet.pattern/dist/leaflet.pattern.js"></script>

  <!-- PapaParse (IMPORTANT!) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html, body { margin:0; height:100%; }
    #map { width:100%; height:100%; }

    #stateSelector {
      position:absolute;
      top:10px;
      left:10px;
      z-index:9999;
      background:white;
      padding:6px;
      border-radius:4px;
      border:1px solid #777;
    }

    .leaflet-control-zoom { z-index:5000; }

    .legend {
      background:white;
      padding:10px;
      border-radius:6px;
      box-shadow:0 1px 4px rgba(0,0,0,0.3);
      line-height:1.3;
      font-size:14px;
    }
    .legend-item {
      display:flex;
      align-items:center;
      margin-bottom:4px;
    }
    .legend-color {
      width:18px;
      height:18px;
      border:1px solid #555;
      margin-right:6px;
    }
  </style>
</head>

<body>

<select id="stateSelector">
  <option value="">Select state</option>
  <option value="NSW">NSW</option>
  <option value="VIC">VIC</option>
  <option value="QLD">QLD</option>
  <option value="SA">SA</option>
  <option value="WA">WA</option>
  <option value="TAS">TAS</option>
  <option value="NT">NT</option>
  <option value="ACT">ACT</option>
</select>

<div id="map"></div>

<script>

// CSV loader that respects headers (same as your working map)
function loadCSV(url) {
  return fetch(url)
    .then(r => r.text())
    .then(t => Papa.parse(t, { header: true, skipEmptyLines: true }).data);
}

// The property name in your GeoJSON (same as working map)
const LGA_NAME_FIELD = "LGA_NAME25";

// Colours
const welcomingColor = "#4f83cc";  // blue
const crispColor = "#e8a04b";      // orange

// Map init
const map = L.map("map").setView([-25, 134], 4);
L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

// Striped pattern for BOTH
const bothPattern = new L.StripePattern({
  weight: 4,
  spaceWeight: 4,
  color: welcomingColor,
  opacity: 0.7,
  angle: 45
});
bothPattern.addTo(map);

// Load ALL DATA
Promise.all([
  loadCSV("welcoming_lgas.csv"),   // with header: lga_name
  loadCSV("crisp_lgas.csv"),       // with header: LGA
  fetch("LGA_2025_AUST_GDA2020.min.json").then(r => r.json())
])
.then(([welcList, crispList, geojson]) => {

  // Convert to Sets (IMPORTANT: same as your working map)
  const welcomingSet = new Set(
    welcList.map(r => r.lga_name?.trim()).filter(Boolean)
  );

  const crispSet = new Set(
    crispList.map(r => r.LGA?.trim()).filter(Boolean)
  );

  console.log("Welcoming loaded:", welcomingSet);
  console.log("CRISP loaded:", crispSet);

  // Layers for grouping
  const welcomingLayer = L.geoJSON(null);
  const crispLayer = L.geoJSON(null);
  const bothLayer = L.geoJSON(null);
  const otherLayer = L.geoJSON(null);

  function style(f) {
    const name = f.properties[LGA_NAME_FIELD];

    const inW = welcomingSet.has(name);
    const inC = crispSet.has(name);

    if (inW && inC)
      return { fillPattern: bothPattern, color:"#333", weight:1 };

    if (inW)
      return { fillColor: welcomingColor, color:"#333", weight:1, fillOpacity:0.7 };

    if (inC)
      return { fillColor: crispColor, color:"#333", weight:1, fillOpacity:0.7 };

    return { fillColor:"#e5e5e5", color:"#aaa", weight:0.5, fillOpacity:0.3 };
  }

  function each(f, layer) {
    const name = f.properties[LGA_NAME_FIELD];
    const tags = [];
    if (welcomingSet.has(name)) tags.push("Welcoming Cities");
    if (crispSet.has(name)) tags.push("CRISP");
    layer.bindTooltip(`<b>${name}</b><br>${tags.join(" & ") || "None"}`);
  }

  geojson.features.forEach(f => {
    const name = f.properties[LGA_NAME_FIELD];
    const inW = welcomingSet.has(name);
    const inC = crispSet.has(name);
    const opts = { style, onEachFeature: each };

    if (inW && inC) bothLayer.addData(f, opts);
    else if (inW) welcomingLayer.addData(f, opts);
    else if (inC) crispLayer.addData(f, opts);
    else otherLayer.addData(f, opts);
  });

  otherLayer.addTo(map);
  welcomingLayer.addTo(map);
  crispLayer.addTo(map);
  bothLayer.addTo(map);

  map.fitBounds(L.geoJSON(geojson).getBounds());

  // State zooms
  const stateBounds = {
    NSW: [[-37.51, 140.96],[-28.16,153.64]],
    VIC: [[-39.2,140.96],[-33.98,150]],
    QLD: [[-29.18,138],[-9.14,153.55]],
    SA:  [[-38.06,129],[-25,141]],
    WA:  [[-35.1,112],[-13,129]],
    TAS: [[-44,144],[-39,149]],
    NT:  [[-26,129],[-10,138]],
    ACT: [[-35.92,148.75],[-35.12,149.4]]
  };

  document.getElementById("stateSelector").addEventListener("change", e => {
    const st = e.target.value;
    if (stateBounds[st]) map.fitBounds(stateBounds[st]);
  });

  // Legend
  const legend = L.control({ position:"bottomright" });
  legend.onAdd = () => {
    const div = L.DomUtil.create("div", "legend");
    div.innerHTML = `
      <div class="legend-item"><div class="legend-color" style="background:${welcomingColor};"></div>Welcoming Cities</div>
      <div class="legend-item"><div class="legend-color" style="background:${crispColor};"></div>CRISP</div>
      <div class="legend-item"><div class="legend-color" style="
        background: repeating-linear-gradient(45deg, ${welcomingColor}, ${welcomingColor} 4px, white 4px, white 8px);
      "></div>Both</div>
      <div class="legend-item"><div class="legend-color" style="background:#e5e5e5;border-color:#aaa;"></div>Other LGAs</div>
    `;
    return div;
  };
  legend.addTo(map);

});
</script>

</body>
</html>
