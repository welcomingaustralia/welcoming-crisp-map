<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Welcoming Cities + CRISP LGA Map</title>

  <!-- Leaflet core -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet Pattern plugin (for striped “both” areas) -->
  <script src="https://unpkg.com/leaflet.pattern/dist/leaflet.pattern.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    .legend {
      background: white;
      padding: 8px 12px;
      line-height: 1.4;
      font-size: 13px;
      border-radius: 4px;
      box-shadow: 0 0 4px rgba(0,0,0,0.3);
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }
    .legend-color {
      width: 18px;
      height: 18px;
      border: 1px solid #555;
      margin-right: 6px;
    }

    /* Dropdown styling */
    #stateSelector {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 9999;
      padding: 6px;
      background: white;
      border-radius: 4px;
      border: 1px solid #777;
    }
  </style>
</head>

<body>

<!-- State dropdown -->
<select id="stateSelector">
  <option value="">Select a state/territory</option>
  <option value="NSW">New South Wales</option>
  <option value="VIC">Victoria</option>
  <option value="QLD">Queensland</option>
  <option value="SA">South Australia</option>
  <option value="WA">Western Australia</option>
  <option value="TAS">Tasmania</option>
  <option value="NT">Northern Territory</option>
  <option value="ACT">Australian Capital Territory</option>
</select>

<div id="map"></div>

<script>
// --------------------------------------------------
// LOAD CSV (one name per line → Set)
// --------------------------------------------------
function loadCSVAsSet(url) {
  return fetch(url)
    .then(res => res.text())
    .then(text => {
      return new Set(
        text
          .split(/\r?\n/)
          .map(l => l.trim())
          .filter(l => l.length > 0)
      );
    });
}

// --------------------------------------------------
// COLOURS
// --------------------------------------------------
const welcomingColor = "#4f83cc";  // soft blue
const crispColor = "#e8a04b";      // soft amber/orange

// GeoJSON property name containing LGA name
const LGA_NAME_FIELD = "LGA_NAME21";  // this matches ABS file

// --------------------------------------------------
// MAP SETUP
// --------------------------------------------------
const map = L.map("map").setView([-25.5, 134.5], 4);

L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 18,
  attribution: "&copy; OpenStreetMap contributors"
}).addTo(map);

const bothPattern = new L.StripePattern({
  weight: 4,
  spaceWeight: 4,
  color: welcomingColor,
  opacity: 0.7,
  angle: 45
});
bothPattern.addTo(map);

// --------------------------------------------------
// LOAD CSVs + GEOJSON
// --------------------------------------------------
Promise.all([
  loadCSVAsSet("data/welcoming_lgas.csv"),
  loadCSVAsSet("data/crisp_lgas.csv"),
  fetch("data/LGA_2025_AUST_GDA2020.min.json").then(res => res.json())
]).then(([welcomingSet, crispSet, geojsonData]) => {

  const welcomingLayer = L.geoJSON(null);
  const crispLayer = L.geoJSON(null);
  const bothLayer = L.geoJSON(null);
  const otherLayer = L.geoJSON(null);

  function styleFeature(feature) {
    const name = feature.properties[LGA_NAME_FIELD];
    const isWelcoming = welcomingSet.has(name);
    const isCRISP = crispSet.has(name);

    if (isWelcoming && isCRISP) {
      return {
        fillPattern: bothPattern,
        color: "#555",
        weight: 1,
        fillOpacity: 1
      };
    } else if (isWelcoming) {
      return {
        fillColor: welcomingColor,
        color: "#555",
        weight: 1,
        fillOpacity: 0.7
      };
    } else if (isCRISP) {
      return {
        fillColor: crispColor,
        color: "#555",
        weight: 1,
        fillOpacity: 0.7
      };
    } else {
      return {
        fillColor: "#e5e5e5",
        color: "#aaa",
        weight: 0.5,
        fillOpacity: 0.3
      };
    }
  }

  function onEachFeature(feature, layer) {
    const name = feature.properties[LGA_NAME_FIELD];
    const programs = [];
    if (welcomingSet.has(name)) programs.push("Welcoming Cities");
    if (crispSet.has(name)) programs.push("CRISP");

    const label = programs.length ? programs.join(" & ") : "Not in WC/CRISP";
    layer.bindTooltip(`<strong>${name}</strong><br>${label}`);
  }

  geojsonData.features.forEach(feat => {
    const name = feat.properties[LGA_NAME_FIELD];
    const isWelcoming = welcomingSet.has(name);
    const isCRISP = crispSet.has(name);

    const options = { style: styleFeature, onEachFeature };

    if (isWelcoming && isCRISP) bothLayer.addData(feat, options);
    else if (isWelcoming) welcomingLayer.addData(feat, options);
    else if (isCRISP) crispLayer.addData(feat, options);
    else otherLayer.addData(feat, options);
  });

  otherLayer.addTo(map);
  welcomingLayer.addTo(map);
  crispLayer.addTo(map);
  bothLayer.addTo(map);

  map.fitBounds(L.geoJSON(geojsonData).getBounds());

  // ------------------------------------------------
  // LAYER CONTROL
  // ------------------------------------------------
  L.control.layers(null, {
    "Welcoming Cities": welcomingLayer,
    "CRISP": crispLayer,
    "Both WC + CRISP": bothLayer,
    "Other LGAs": otherLayer
  }, { collapsed: false }).addTo(map);

  // ------------------------------------------------
  // LEGEND
  // ------------------------------------------------
  const legend = L.control({ position: "bottomright" });

  legend.onAdd = function() {
    const div = L.DomUtil.create("div", "legend");
    div.innerHTML = `
      <div class="legend-item">
        <div class="legend-color" style="background:${welcomingColor}"></div>
        Welcoming Cities
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background:${crispColor}"></div>
        CRISP
      </div>
      <div class="legend-item">
        <div class="legend-color" 
             style="background: repeating-linear-gradient(45deg, ${welcomingColor}, ${welcomingColor} 4px, white 4px, white 8px);"></div>
        Both
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background:#e5e5e5; border-color:#aaa;"></div>
        Other LGAs
      </div>
    `;
    return div;
  };
  legend.addTo(map);

  // ------------------------------------------------
  // STATE ZOOMING
  // ------------------------------------------------
  const stateBounds = {
    "NSW": [[-37.51, 140.96], [-28.16, 153.64]],
    "VIC": [[-39.2, 140.96], [-33.98, 150.0]],
    "QLD": [[-29.18, 138.0], [-9.14, 153.55]],
    "SA":  [[-38.06, 129.0], [-25.0, 141.0]],
    "WA":  [[-35.1, 112.0], [-13.0, 129.0]],
    "TAS": [[-44.0, 144.0], [-39.0, 149.0]],
    "NT":  [[-26.0, 129.0], [-10.0, 138.0]],
    "ACT": [[-35.92, 148.75], [-35.12, 149.4]]
  };

  document.getElementById("stateSelector").addEventListener("change", e => {
    const state = e.target.value;
    if (state && stateBounds[state]) {
      map.fitBounds(stateBounds[state]);
    }
  });

});
</script>

</body>
</html>
